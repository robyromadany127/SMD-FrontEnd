name: Auto Deploy Frontend (Zero Downtime)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: dev

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 23

    - name: Install dependencies
      run: npm install

    - name: Build React app
      run: npm run build

    - name: Validate Build Output
      run: |
        if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
          echo "Build directory is empty!"
          exit 1
        fi

    - name: Debug build output
      run: ls -lah dist

    - name: Set deployment timestamp
      id: set_timestamp
      run: echo "TIMESTAMP=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

    - name: Upload build to VPS (Blue-Green Deployment)
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          sudo mkdir -p /var/www/frontend/releases
          NEW_RELEASE="/var/www/frontend/releases/${{ env.TIMESTAMP }}"
          sudo mkdir -p $NEW_RELEASE
          echo "Uploading new build to $NEW_RELEASE..."

    - name: SCP Upload to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "dist/*"
        target: "/var/www/frontend/releases/${{ env.TIMESTAMP }}"

    - name: Create .env file on VPS
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          NEW_RELEASE="/var/www/frontend/releases/${{ env.TIMESTAMP }}"
          echo -n "${{ secrets.ENV_FILE }}" | sudo tee $NEW_RELEASE/.env > /dev/null

    - name: Update Nginx Configuration
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          echo "Updating Nginx configuration..."
          sudo tee /etc/nginx/sites-available/frontend > /dev/null <<EOF
          server {
              server_name dev.smd.nyv.my.id www.dev.smd.nyv.my.id;
              root /var/www/frontend/current;
              index index.html;
              location / {
                  try_files \$uri /index.html;
              }
              listen 443 ssl http2;
              ssl_certificate /etc/letsencrypt/live/dev.smd.nyv.my.id/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/dev.smd.nyv.my.id/privkey.pem;
              include /etc/letsencrypt/options-ssl-nginx.conf;
              ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
              location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|eot|ttf|svg)$ {
                  expires 6M;
                  access_log off;
                  add_header Cache-Control "public";
              }
          }
          server {
              listen 80;
              server_name dev.smd.nyv.my.id www.dev.smd.nyv.my.id;
              return 301 https://\$host\$request_uri;
          }
          EOF
          sudo ln -sf /etc/nginx/sites-available/frontend /etc/nginx/sites-enabled/frontend
          sudo nginx -t && sudo systemctl reload nginx

    - name: Switch Symlink to New Release
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          NEW_RELEASE="/var/www/frontend/releases/${{ env.TIMESTAMP }}"
          if [ ! -d "$NEW_RELEASE" ]; then
            echo "Error: New release directory not found!"
            exit 1
          fi
          echo "Switching symlink to $NEW_RELEASE..."
          sudo ln -sfn $NEW_RELEASE /var/www/frontend/current
          sudo systemctl reload nginx
          ls -td /var/www/frontend/releases/* | tail -n +4 | xargs sudo rm -rf
